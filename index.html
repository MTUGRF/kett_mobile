<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#285756" >
    <title>KeTT Mobile App</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css">
    <link href="https://www.dafontfree.net/embed/cGF0cmljaWFuLXJlZ3VsYXImZGF0YS8yNi9wLzEzODA1Ny9QYXRyaWNhbi50dGY" rel="stylesheet" type="text/css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gentium+Book+Plus&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-request@4.0.0/dist/bundled/request.umd.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-feature-service@4.0.0/dist/bundled/feature-service.umd.js"></script>
    <script src="https://js.arcgis.com/4.23/"></script>
    <style>
     

    /*  :root {
      --ion-font-family: 'patrician-regular';
      }*/

      :root {
        --ion-font-family:  'Lato', sans-serif;
        --ion-color-favorite: #CC6131;
        --ion-color-favorite-contrast: #FFFFFF;
        --ion-color-header: #285756;
        --ion-color-white: #FFFFFF;
        --ion-color-locate: #FFFFFF;
      }

      #viewDiv {
        text-align: center;
        height: 100%;
        width: 100%;
        position: absolute;
        left: 0;
        right: 0;
      }

      .ion-color-favorite {
        --ion-color-base: var(--ion-color-favorite);      
      }

      .ion-color-white {
        --ion-color-base: var(--ion-color-white);      
      }

      .ion-color-header {
        --ion-color-base: var(--ion-color-header);        
      }

      .ion-color-locate {
        --ion-color-base: var(--ion-color-locate);
      }

     /* .ion-color-primary {
        --ion-color-base:  var(--ion-color-primary, #363636)!important;
      }
*/
      ion-range {
        --knob-box-shadow:  0 3px 1px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.13), 0 0 0 1px rgba(0, 0, 0, 0.02);
        --bar-background: #83A1A0;
        --bar-background-active: #d7d8da;
        --bar-height: 8px;
        --bar-border-radius: 8px;
        --knob-background: #ffffff;
        --knob-size: 40px;
        --pin-background: #ffafcc;
        --pin-color: #fff;        
        width: 80%;
        position:  absolute;
        left:  30px;
        top:  bottom: 30px;        
      }

      .media-label {
        margin-left: 40%;        
        font-size: 20px;" 
        margin-bottom: 20px;
        letter-spacing: 1px;
      }

      .esri-view .esri-view-surface--inset-outline:focus::after {
        outline: none !important;
      }   ‍‍‍

      .focus {
      	color: red;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <ion-header>
        <ion-toolbar color="header">
          <ion-buttons slot="start">
            <ion-img src="https://kett.geospatialresearch.mtu.edu/static/media/logo_mark_only@2x.a10ff43f.png" style="width: 60px; height: 60px;"></ion-img>
          </ion-buttons>
          <ion-buttons slot="end">
          	<ion-text color="white">
            <ion-menu-button auto-hide="false" id="menuBtn"></ion-menu-button>
        </ion-text>
          </ion-buttons>
          <ion-popover trigger="menuBtn" dismiss-on-select="true">
          <ion-content>
            <ion-list>
              <ion-item button="true" detail="false">About the project</ion-item>
              <ion-item button="true" detail="false">Project news</ion-item>
              <ion-item button="true" detail="false">Meet the team</ion-item>
              <ion-item button="true" detail="false">Help</ion-item>              
            </ion-list>
          </ion-content>
        </ion-popover>
        <ion-text color="white">	
          <ion-title>KeTT Mobile Beta</ion-title>
      </ion-text>
        </ion-toolbar>
      </ion-header> 

      <ion-tabs>
        <ion-tab tab="home">
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>Explore</ion-title>
            </ion-toolbar>
          </ion-header>     
     	  <ion-content [fullscreen]="true">          
      		<div id="viewDiv"></div>           
          <ion-range value="100"></ion-range> 
          <ion-fab horizontal="end" vertical="bottom" slot="fixed">
          <ion-fab-button color="locate" id="geolocation">
            <ion-icon name="locate-sharp" id="gpsicon"></ion-icon>
          </ion-fab-button>
        </ion-fab>
       </ion-content> 
        </ion-tab>

        <ion-tab tab="maps">
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>Maps</ion-title>
            </ion-toolbar>
          </ion-header>

          <ion-content fullscreen class="ion-padding" id="mapcontent">            
          Maps
          </ion-content>
        </ion-tab>

        <ion-tab tab="stories">
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>Stories</ion-title>
            </ion-toolbar>
          </ion-header>

          <ion-content fullscreen class="ion-padding">
            <h1>Share a Story</h1>
          </ion-content>
        </ion-tab>
        <ion-tab-bar slot="bottom">
          <ion-tab-button tab="home">
            <ion-label>Explore</ion-label>
            <ion-icon name="location-outline"></ion-icon>
          </ion-tab-button>
          <ion-tab-button tab="maps">
            <ion-label>Maps</ion-label>
            <ion-icon name="map-outline"></ion-icon>
            <ion-badge id="mapcount">6</ion-badge>
          </ion-tab-button>
          <ion-tab-button tab="stories">
            <ion-label>Share a Story</ion-label>
            <ion-icon name="book-outline"></ion-icon>
          </ion-tab-button>
        </ion-tab-bar>
      </ion-tabs>         
  </ion-content> 
    <ion-modal>
      <ion-header>
        <ion-toolbar color="favorite">
        	<ion-text color="white">
          <ion-title id="storymodaltitle">Story</ion-title>
      </ion-text>
          <ion-buttons slot="end">
          	<ion-text color="white">
            <ion-button id="modalClose">Close</ion-button>
        </ion-text>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
       <ion-card>
          <img src="" id="storyimg" />
          <ion-card-header>
            <ion-card-subtitle id="subtitle"></ion-card-subtitle>
            <ion-card-title id="storytitle">Madison, WI</ion-card-title>
          </ion-card-header>
          <ion-card-subtitle id="storyauthor" style="margin-left: 15px;"></ion-card-subtitle>
          <ion-card-content id="storydesc">
            Founded in 1829 on an isthmus between Lake Monona and Lake Mendota, Madison was named the capital of the
            Wisconsin Territory in 1836.              
          </ion-card-content>   
          <ion-label id="piclabel" class="media-label">Pictures</ion-label> 
          <div id="pictures"></div>      
          <ion-label id="vidlabel" class="media-label">Videos</ion-label>
          <div id="videos"></div>                  
          <ion-label id=audlabel class="media-label">Audio</ion-label>        
          <div id="sound"></div>  
        </ion-card>
      </ion-content>
    </ion-modal>
</ion-app>
  </body>
</html>
<script>
  require(["esri/config","esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/layers/TileLayer", "esri/widgets/Track", "esri/Graphic", "esri/layers/GraphicsLayer", "esri/geometry/support/webMercatorUtils"], function (esriConfig, Map, MapView, FeatureLayer, TileLayer, Track, Graphic, GraphicsLayer, webMercatorUtils) {

        // function to hyperlink URLs in stories
        function replaceURLs(message) {
          if(!message) return;

          const urlRegex = /(((https?:\/\/)|(www\.))[^\s]+)/g;
          return message.replace(urlRegex, function (url) {
            let hyperlink = url;
            if (!hyperlink.match('^https?:\/\/')) {
              hyperlink = 'http://' + hyperlink;
            }
            return '<a href="' + hyperlink + '" target="_blank" rel="noopener noreferrer">' + url + '</a>'
          });
        };        

        var modal = document.querySelector('ion-modal');        

       // modal.breakpoints = [0, 0.25, 0.5, 0.75];
  
        // styling for the story points layer
        const storiesRenderer = {
          "type": "simple",
          "symbol": {
            "type": "picture-marker",
            "url": "assets/marker_story.png",
            "width": "18px",
            "height": "18px"
          }
        };

        // Layer for the map index 
	    const indexLayer = new FeatureLayer({
	      url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/KeTT_Mobile_Map_Indexes/FeatureServer/0",
	      outFields: ["*"], // Return all fields so it can be queried client-side
	      opacity: 0
	    //renderer: renderer
	    });

        // Layer for the story points
        const storyLayer = new FeatureLayer({
          url: "https://portal1-geo.sabu.mtu.edu:6443/arcgis/rest/services/KeweenawHSDI/story_pts_watts2/FeatureServer/0",
          outFields: ["*"], // Return all fields so it can be queried client-side        
          renderer: storiesRenderer
        });

        const graphicsLayer = new GraphicsLayer();
	    //map.add(graphicsLayer);

        const map = new Map({
          basemap: "satellite", // Basemap layer service
          layers: [indexLayer, storyLayer, graphicsLayer]
        });

        const view = new MapView({
          map: map,
          center: [-88.5694, 47.1211], // Longitude, latitude
          zoom: 10, // Zoom level
          container: "viewDiv", // Div element
          
        });       
        // Removes the zoom widget from the view
        view.ui.remove("zoom");        

        view.on("hold", function(evt) {
          // if there are any markers on the map remove them	
          graphicsLayer.removeAll();	
          const extent = view.extent;        

          /*const queryGeometry = {
            xmin: extent.xmin,
            ymin: extent.ymin,
            xmax: extent.xmax,
            ymax: extent.ymax, 
            spatialReference: {
              wkid: 3857
            }
          };*/
         
          const lat = evt.mapPoint.latitude
          const lon =evt.mapPoint.longitude
          const queryGeometry = {
            x: lon,
            y: lat,
            spatialReference: {
              wkid: 4326
            }
          };

          console.log(lat,lon, queryGeometry);

          arcgisRest
            .queryFeatures({
              url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/giscore_grf_kett_record_locs/FeatureServer/0",
              geometry: queryGeometry,
              geometryType: "esriGeometryPoint",
              spatialRel: "esriSpatialRelIntersects",
              distance: 100,
              units: "esriSRUnit_Foot",
              //SR: "4326",
              //authentication
            })
            .then((response) => {
            	/*const placeMarkerSymbol = {
      			    type: "simple-marker",
      			    color: [226, 119, 40],  // Orange
      			    outline: {
      			        color: [255, 255, 255], // White
      			        width: 1
      			    }
      			  };
*/
              const placeMarkerSymbol = {          
                "type": "picture-marker",
                "url": "assets/marker_place.png",
                "width": "18px",
                "height": "18px"          
              };

              const personMarkerSymbol = {          
                "type": "picture-marker",
                "url": "assets/marker_person.png",
                "width": "18px",
                "height": "18px"          
              };


              /*const personMarkerSymbol = {
                type: "simple-marker",
                color: [226, 4, 49],  // Orange
                outline: {
                    color: [255, 255, 255], // White
                    width: 1
                }
              };*/

              console.log(response.features);
              const features = response.features;
              features.forEach(function(feature) {
                // convert the coordinates into decimal degrees
	              const ddCoords = webMercatorUtils.webMercatorToGeographic(feature.geometry);
				  
	              const point = { //Create a point
      				    type: "point",
      				    longitude: ddCoords.x,
      				    latitude:  ddCoords.y,
      				  };				  

      				 const pointGraphic = new Graphic({
      				    geometry: point,
      				   // symbol: simpleMarkerSymbol
      				 });

               if (feature.attributes.entitytype == "person") {
                pointGraphic.symbol = personMarkerSymbol;
               } else if (feature.attributes.entitytype == "building") {
                pointGraphic.symbol = placeMarkerSymbol;
               }
      	 			 graphicsLayer.add(pointGraphic);
       			 });
              //document.getElementById("result").textContent = JSON.stringify(response.features, null, 2);
            });
          /*// query the maps extent for any people or places from the feature service. 
          arcgisRest
            .queryFeatures({
              url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/giscore_grf_kett_record_locs/FeatureServer/0",
              geometry: queryGeometry,
              geometryType: "esriGeometryEnvelope",
              spatialRel: "esriSpatialRelContains",
              //authentication
            })
            .then((response) => {
              console.log(response.features);
              //document.getElementById("result").textContent = JSON.stringify(response.features, null, 2);
            });*/
		    });

        // new gelocation widget
        let track = new Track({
          view: view,
          goToLocationEnabled: true, 
          geolocationOptions: { maximumAge: 0, timeout: 15000, enableHighAccuracy: true }
        });

        //view.ui.add(track, "top-left"); 

        // The sample will start tracking your location
        // once the view becomes ready
        view.when(function () {
          
        });

        $( "#geolocation" ).click(function() {
         // track.start();
         if (track.tracking == false) {
         	track.start();
         	document.getElementById("gpsicon").style.color = "#3880ff";
         } else {
         	track.stop();
         	document.getElementById("gpsicon").style.color = "black";
         }
       
         
        });

        const listNode = document.getElementById("mapcontent");

        let graphics; 
  	    view.whenLayerView(indexLayer).then(function(layerView) {
    		  layerView.watch("updating", function(value) { 
    		  	  listNode.innerHTML = "";	  		  	  		  	  	
  			  if (!value) {			  	
  			    // wait for the layer view to finish updating

  			    // get all the features available for drawing.
  			    layerView
  			      .queryFeatures({
  			        geometry: view.extent,
  			        returnGeometry: true
  			      })
  			      .then(function(results) {
  			        // do something with the resulting graphics
  			        graphics = results.features;

                document.getElementById("mapcount").innerHTML = results.features.length;
  			       	let item;
  			        const fragment = document.createDocumentFragment();
  			        graphics.forEach(function(result, index) {
                        const attributes = result.attributes;
                        const title = attributes.title;
                        const year = attributes.year;
                        console.log(title);
                        item = document.createElement("ion-item");
                        const label = document.createElement("ion-label");
                        const icon = document.createElement("ion-icon"); 
                        item.href = "#";                     
                        icon.name = "map-outline";                      
                        icon.slot = "end";
                        label.innerHTML = year + " " + title;	
                        item.appendChild(icon);
                        item.appendChild(label);
                        item.addEventListener("click", () => resultClickHandler(result, index));
                        fragment.appendChild(item);                     
                   	    listNode.appendChild(fragment);
                      });  

  			        function resultClickHandler(result, index) {  
  			        	item.classList.add("focus");			        	
                  		const tabs = document.querySelector('ion-tabs');
                  		tabs.select('home');
  				        const popup = graphics && graphics[parseInt(index, 10)];
  				     
    				    map.allLayers.filter(function(layer) {
  				     	  if (layer.type === "tile") {
  				     		  map.remove(layer);
  				     	  } 
                		});			    

  				        let current_layer = new TileLayer({
  			              url: result.attributes.service_url
  			        	});

  			        	map.add(current_layer);

		                // push the current layer to the back
		                map.reorder(current_layer, 1);

		                // get the value of the range slider  
		                let rangeVal = $( "ion-range" ).val();
		               
		                current_layer.opacity = rangeVal / 100;  

		                const range = document.querySelector('ion-range');
		                // const lastEmittedValue = document.querySelector('#lastValue');
		                // adjust the transparency of the map based on the sliders value  
		                range.addEventListener('ionChange', ({ detail }) => {
		                  //lastEmittedValue.innerHTML = detail.value;
		                    current_layer.opacity = detail.value / 100;                  
		                });			        

  				      /*if (popup) {
  				        view.popup.open({
  				          features: [popup],
  				          location: result.geometry.centroid
  				        });       
  				        const extent = result.geometry.extent;
  				        // when clicking on a record zoom to its extent
  				        view.goTo({ center: extent.expand(6) }, { duration: 400 });
  				      }				     */
  				      };
  			      });
  			  }
  		  });	
  		});

        view.on("click", (event) => {
          // only include graphics from the layer in the hitTest
          const opts = {
            include: storyLayer
          }
          // check for a click on the story layer
          view.hitTest(event, opts).then((response) => {
            $("#storyimg").attr("src", ""); 
            $("#piclabel").hide();
            $("#audlabel").hide();
            $("#vidlabel").hide();
            document.getElementById("pictures").innerHTML = "";
            document.getElementById("videos").innerHTML = "";
            document.getElementById("sound").innerHTML = "";           

            // check if a feature is returned from the index layer
            if (response.results.length) {
              const graphic = response.results[0].graphic; 
              console.log(graphic);
              const objectId = graphic.attributes.objectid;
              const title = graphic.attributes.title;
              const desc = replaceURLs(graphic.attributes.description);
              const date = graphic.attributes.userdate;
              const name = graphic.attributes.name;
              $('#subtitle').html(date); 
              $('#storydesc').html(desc); 
              $('#storytitle').html(title); 
              $('#storymodaltitle').html(title);
              if (name == "" || name == null  ) {
              	$('#storyauthor').html("by Anonymous");
              } else {
              	$('#storyauthor').html("by " + name);
              }
              
              modal.isOpen = true;
              // Query the attachments from the clicked story
              storyLayer.queryAttachments({
              //  attachmentTypes: ["image/jpeg", "video/mp4", "sound/mp3"],
                objectIds: objectId
              }).then(function (attachmentsByFeatureId) {
                console.log(attachmentsByFeatureId);
                if (!attachmentsByFeatureId) {
                    return;
                 }
                if (Object.keys(attachmentsByFeatureId).length === 0){
                  // if there are no attachments, do something here.
                  $("#storyimg").attr("src", "");                   
                 }
                // Display the attachments
                Object.keys(attachmentsByFeatureId)
                  .forEach(function(objectId) {
                    const attachments = attachmentsByFeatureId[objectId];
                    attachments.forEach(function (attachment) {                   
                      if (attachment.contentType == "image/jpeg" || attachment.contentType == "image/png" || attachment.contentType == "image/gif") {
                       
                        const imgarray = [];
                        imgarray.push(attachment);
                        const attachUrl = imgarray[0].url;
                        $("#storyimg").attr("src",attachUrl);
                        imgarray.forEach(function(image) {
                          if (image.url != attachUrl) {
                            $("#piclabel").show();
                         		const elem = document.createElement("img");
                         		elem.src = image.url;
                         		document.getElementById("pictures").appendChild(elem);
                          }
                        }); 
                        console.log(attachUrl);
                      } else if (attachment.contentType == "video/mp4") {
                        $("#vidlabel").show();
                        const vidarray = [];
                        vidarray.push(attachment);
                        const vidUrl = vidarray[0].url;
                        const video = document.createElement('video');
                       // video.classList.add("controls");
            						const source = document.createElement('source');

            						source.setAttribute('src', vidUrl);
            						source.setAttribute('type', 'video/mp4');
                        document.getElementById("videos").appendChild(video);

            						video.appendChild(source);	
                        video.controls = "true";  
                        video.style.width = "100%";
            						video.load();
                      } else if (attachment.contentType == "audio/mpeg") {
                        $("#audlabel").show();
                      	const audarray = [];
                      	audarray.push(attachment);
                      	const audUrl = audarray[0].url;
                      	const audio = document.createElement('audio');
            						const source = document.createElement('source');

            						source.setAttribute('src', audUrl);
            						source.setAttribute('type', 'audio/mpeg');
                        document.getElementById("sound").appendChild(audio);
            						audio.appendChild(source);	
                        audio.controls = "true";
                        audio.style.width = "100%";
            						audio.load();
                      }
                    });
                  }); 
              });
            }    
          });
        });
         modal.addEventListener('didDismiss', (ev) => {
           modal.isOpen = false;
         });
         $( "#modalClose" ).click(function() {
         	modal.isOpen = false;
         });
    });
</script>
<style>
  ion-content ion-toolbar {
    margin: 10px 0;
  }
</style>
