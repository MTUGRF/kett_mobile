<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toolbar</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css">
    <link href="https://www.dafontfree.net/embed/cGF0cmljaWFuLXJlZ3VsYXImZGF0YS8yNi9wLzEzODA1Ny9QYXRyaWNhbi50dGY" rel="stylesheet" type="text/css"/>
     <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
      <script src="https://unpkg.com/@esri/arcgis-rest-request@4.0.0/dist/bundled/request.umd.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-feature-service@4.0.0/dist/bundled/feature-service.umd.js"></script>
    <script src="https://js.arcgis.com/4.24/"></script>
    <style>
     

    /*  :root {
      --ion-font-family: 'patrician-regular';
      }*/

      #viewDiv {
        text-align: center;
        height: 100%;
        width: 100%;
        position: absolute;
        left: 0;
        right: 0;
      }

      .ion-color-primary {
        --ion-color-base:  var(--ion-color-primary, #363636)!important;
      }

      ion-range {
        --bar-background: #a2d2ff;
        --bar-background-active: #bde0fe;
        --bar-height: 8px;
        --bar-border-radius: 8px;
        --knob-background: #ffc8dd;
        --knob-size: 40px;
        --pin-background: #ffafcc;
        --pin-color: #fff;        
        width: 80%;
        position:  absolute;
        left:  30px;
        top:  bottom: 30px;
      }

      .esri-view .esri-view-surface--inset-outline:focus::after {
        outline: none !important;
      }   ‍‍‍
    </style>
  </head>
  <body>
    <ion-app>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-buttons slot="start">
            <ion-img src="https://kett.geospatialresearch.mtu.edu/static/media/logo_mark_only@2x.a10ff43f.png" style="width: 60px; height: 60px;"></ion-img>
          </ion-buttons>
          <ion-buttons slot="end">
            <ion-menu-button auto-hide="false" id="menuBtn"></ion-menu-button>
          </ion-buttons>
          <ion-popover trigger="menuBtn" dismiss-on-select="true">
          <ion-content>
            <ion-list>
              <ion-item button="true" detail="false">About the project</ion-item>
              <ion-item button="true" detail="false">Project news</ion-item>
              <ion-item button="true" detail="false">Meet the team</ion-item>              
            </ion-list>
          </ion-content>
        </ion-popover>
          <ion-title>KeTT Mobile Beta</ion-title>
        </ion-toolbar>
      </ion-header>      
      <ion-tabs>
        <ion-tab tab="home">
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>Home</ion-title>
            </ion-toolbar>
          </ion-header>

     	  <ion-content [fullscreen]="true">
      		<div id="viewDiv"></div>           
          <ion-range value="100"></ion-range> 
          <ion-fab horizontal="end" vertical="bottom" slot="fixed">
          <ion-fab-button color="danger" id="geolocation">
            <ion-icon name="locate-sharp"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      	  </ion-content> 
        </ion-tab>

        <ion-tab tab="maps">
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>Maps</ion-title>
            </ion-toolbar>
          </ion-header>

          <ion-content fullscreen class="ion-padding" id="mapcontent">            
          Maps
          </ion-content>
        </ion-tab>

        <ion-tab tab="games">
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>Games</ion-title>
            </ion-toolbar>
          </ion-header>

          <ion-content fullscreen class="ion-padding">
            <h1>Games</h1>
          </ion-content>
        </ion-tab>

        <ion-tab-bar slot="bottom">
          <ion-tab-button tab="home">
            <ion-label>Home</ion-label>
            <ion-icon name="map-outline"></ion-icon>
          </ion-tab-button>
          <ion-tab-button tab="maps">
            <ion-label>Maps</ion-label>
            <ion-icon name="videocam"></ion-icon>
            <ion-badge id="mapcount">6</ion-badge>
          </ion-tab-button>
          <ion-tab-button tab="games">
            <ion-label>Games</ion-label>
            <ion-icon name="game-controller"></ion-icon>
          </ion-tab-button>
        </ion-tab-bar>
      </ion-tabs>   
    </ion-app>
  </body>
</html>
<script>
  require(["esri/config","esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/layers/TileLayer", "esri/widgets/Track"], function (esriConfig,Map, MapView, FeatureLayer, TileLayer, Track) {

        esriConfig.apiKey = "YOUR_API_KEY";

        // Layer for the nautical charts 
	      const indexLayer = new FeatureLayer({
	        url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/KeTT_Mobile_Map_Indexes/FeatureServer/0",
	        outFields: ["*"], // Return all fields so it can be queried client-side
	    //renderer: renderer
	      });

        const map = new Map({
          basemap: "satellite", // Basemap layer service
          layers: [indexLayer]
        });

        const view = new MapView({
          map: map,
          center: [-88.5694, 47.1211], // Longitude, latitude
          zoom: 10, // Zoom level
          container: "viewDiv" // Div element
        });       
        // Removes the zoom widget from the view
        view.ui.remove("zoom");

        view.on("drag", function(evt) {
          const extent = view.extent;
          
          let xmin = extent.xmin;
          let xmax = extent.xmax;
          let ymin = extent.ymin;
          let ymax = extent.ymax;

          const queryGeometry = {
            xmin: xmin,
            ymin: ymin,
            xmax: xmax,
            ymax: ymax, 
            spatialReference: {
              wkid: 3857
            }
          };
         /* // query the maps extent for any people of places from the feature service. 
          arcgisRest
            .queryFeatures({
              url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/giscore_grf_kett_record_locs/FeatureServer/0",
              geometry: queryGeometry,
              geometryType: "esriGeometryEnvelope",
              spatialRel: "esriSpatialRelContains",
              //authentication
            })
            .then((response) => {
              console.log(response.features);
              //document.getElementById("result").textContent = JSON.stringify(response.features, null, 2);
            });
		    });*/

        // new gelocation widget
        let track = new Track({
          view: view
        });

        $( "#geolocation" ).click(function() {
          track.start();
        });

        const listNode = document.getElementById("mapcontent");

        let graphics; 
  	    view.whenLayerView(indexLayer).then(function(layerView) {
    		  layerView.watch("updating", function(value) { 
    		  	  listNode.innerHTML = "";	  		  	  		  	  	
  			  if (!value) {			  	
  			    // wait for the layer view to finish updating

  			    // get all the features available for drawing.
  			    layerView
  			      .queryFeatures({
  			        geometry: view.extent,
  			        returnGeometry: true
  			      })
  			      .then(function(results) {
  			        // do something with the resulting graphics
  			        graphics = results.features;

                document.getElementById("mapcount").innerHTML = results.features.length;
  			       
  			        const fragment = document.createDocumentFragment();
  			        graphics.forEach(function(result, index) {
                        const attributes = result.attributes;
                        const title = attributes.title;
                        console.log(title);
                        const item = document.createElement("ion-item");
                        const label = document.createElement("ion-label");
                        const icon = document.createElement("ion-icon"); 
                        item.href = "#";                     
                        icon.name = "map-outline";                      
                        icon.slot = "end";
                        label.innerHTML = title;	
                        item.appendChild(icon);
                        item.appendChild(label);
                        item.addEventListener("click", () => resultClickHandler(result, index));
                        fragment.appendChild(item);                     
                   	    listNode.appendChild(fragment);
                      });  

  			        function resultClickHandler(result, index) {
  				        const popup = graphics && graphics[parseInt(index, 10)];
  				     
    				      map.allLayers.filter(function(layer) {
    				     	  if (layer.type === "tile") {
    				     		  map.remove(layer);
    				     	  } 
                  });			    

  				      let current_layer = new TileLayer({
  			            url: result.attributes.service_url
  			        });

  			        map.add(current_layer);
                // get the value of the range slider  
                let rangeVal = $( "ion-range" ).val();
               
                current_layer.opacity = rangeVal / 100;  

                const range = document.querySelector('ion-range');
                // const lastEmittedValue = document.querySelector('#lastValue');
                // adjust the transparency of the map based on the sliders value  
                range.addEventListener('ionChange', ({ detail }) => {
                  //lastEmittedValue.innerHTML = detail.value;
                    current_layer.opacity = detail.value / 100;                  
                });			        

  				      /*if (popup) {
  				        view.popup.open({
  				          features: [popup],
  				          location: result.geometry.centroid
  				        });       
  				        const extent = result.geometry.extent;
  				        // when clicking on a record zoom to its extent
  				        view.goTo({ center: extent.expand(6) }, { duration: 400 });
  				      }				     */
  				      };
  			      });
  			  }
  		  });	
  		});
      });
</script>
<style>
  ion-content ion-toolbar {
    margin: 10px 0;
  }
</style>