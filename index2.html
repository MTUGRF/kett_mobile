<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#285756" >
    <title>KeTT Mobile App</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css">
    <link href="https://www.dafontfree.net/embed/cGF0cmljaWFuLXJlZ3VsYXImZGF0YS8yNi9wLzEzODA1Ny9QYXRyaWNhbi50dGY" rel="stylesheet" type="text/css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gentium+Book+Plus&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-request@4.0.0/dist/bundled/request.umd.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-feature-service@4.0.0/dist/bundled/feature-service.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/linkifyjs@3.0.5/dist/linkify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/linkify-html@3.0.5/dist/linkify-html.min.js"></script>
    <script src="https://js.arcgis.com/4.24/"></script>
    <style>
     

    /*  :root {
      --ion-font-family: 'patrician-regular';
      }*/

      :root {
        --ion-font-family:  'Lato', sans-serif;
        --ion-color-favorite: #CC6131;
        --ion-color-favorite-contrast: #FFFFFF;
        --ion-color-header: #285756;
        --ion-color-white: #FFFFFF;
        --ion-color-locate: #FFFFFF;
        --ion-color-green:  #69bb7b;
        --ion-color-red:  #e00000;
        --ion-color-gray: #363636;
      }

      #viewDiv {
        text-align: center;
        height: 100%;
        width: 100%;
        position: absolute;
        left: 0;
        right: 0;
      }

      .ion-color-favorite {
        --ion-color-base: var(--ion-color-favorite);      
      }

      .ion-color-white {
        --ion-color-base: var(--ion-color-white);      
      }

      .ion-color-header {
        --ion-color-base: var(--ion-color-header);        
      }

      .ion-color-locate {
        --ion-color-base: var(--ion-color-locate);
      }

      .ion-color-green {
        --ion-color-base: var(--ion-color-green); 
      }

      .ion-color-red {
        --ion-color-base: var(--ion-color-red);       
      }

      .ion-color-gray {
        --ion-color-base: var(--ion-color-gray);
      }

     /* .ion-color-primary {
        --ion-color-base:  var(--ion-color-primary, #363636)!important;
      }
*/
      ion-range {
        --knob-box-shadow:  0 3px 1px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.13), 0 0 0 1px rgba(0, 0, 0, 0.02);
        --bar-background: #83A1A0;
        --bar-background-active: #d7d8da;
        --bar-height: 8px;
        --bar-border-radius: 8px;
        --knob-background: #ffffff;
        --knob-size: 40px;
        --pin-background: #ffafcc;
        --pin-color: #fff;        
        width: 80%;
        position:  absolute;
        left:  30px;               
      }

      .media-label {
        text-align: center;        
        font-size: 20px;
        margin-bottom: 20px;
        letter-spacing: 1px;
      }

      .esri-view .esri-view-surface--inset-outline:focus::after {
        outline: none !important;
      } 
    
      .swiper-slide {
        display: block;
        margin-top: 56px;
      }

      .swiper-slide h2 {
        margin-top: 2.8rem;
      }

      .swiper-slide img {
        max-height: 50%;
        max-width: 80%;
        margin: 60px 0 40px;
        pointer-events: none;
      }      

      .green {
        --background: #5ca56c;
        height: 120px;
        width: 120px;        
      } 

      .item-background-color{
        --ion-item-background:#ffffff;
      } 
  
      #micicon {
        width: 100px;
        height: 100px;
      }   
      /* CSS specific to iOS devices */ 
      @supports (-webkit-touch-callout: none) {
        ion-range {
          padding-top: 25px;
        }  
      }  

      b {
        font-weight: 500;
      }

      p {
        padding: 0 40px;
        font-size: 14px;
        line-height: 1.5;
        color: var(--ion-color-step-600, #60646b);
      }

      p b {
        color: var(--ion-text-color, #000000);
      }

      @-webkit-keyframes pulse { 
        70% { 
          box-shadow: 0 0 0 50px rgba(#5a99d4, 0);
        }
        100% { 
          box-shadow: 0 0 0 0 rgba(#5a99d4, 0);
        }
      }
     
    </style>
  </head>
  <body>
    <ion-app>
      <ion-header>
        <ion-toolbar color="header">
          <ion-buttons slot="start">
            <ion-img src="https://kett.geospatialresearch.mtu.edu/static/media/logo_mark_only@2x.a10ff43f.png" style="width: 60px; height: 60px;"></ion-img>
          </ion-buttons>
          <ion-buttons slot="end">
          	<ion-text color="white">
            <ion-menu-button auto-hide="false" id="menuBtn"></ion-menu-button>
        </ion-text>
          </ion-buttons>
          <ion-popover trigger="menuBtn" dismiss-on-select="true">
          <ion-content>
            <ion-list>
              <ion-item button="true" detail="false" href="https://www.keweenawhistory.com/about-the-project.html">About the project</ion-item>
              <ion-item button="true" detail="false" href="https://www.keweenawhistory.com/project-news">Project news</ion-item>
              <ion-item button="true" detail="false" href="https://www.keweenawhistory.com/meet-the-team.html">Meet the team</ion-item>
              <ion-item button="true" detail="false">Help</ion-item>              
            </ion-list>
          </ion-content>
        </ion-popover>
        <ion-text color="white">	
          <ion-title>Keweenaw Time Traveler</ion-title>
      </ion-text>
        </ion-toolbar>
      </ion-header> 

      <ion-tabs>
        <ion-tab tab="home">
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>Explore</ion-title>
            </ion-toolbar>
          </ion-header>     
     	  <ion-content [fullscreen]="true">  
         <ion-modal id="splashModal">
      <ion-header>
        <ion-toolbar color="gray">
          <ion-text color="white">
          <ion-title>Welcome to KeTT Mobile</ion-title>
      </ion-text>
          <ion-buttons slot="end">
            <ion-text color="white">
            <ion-button id="splashModalClose">Close</ion-button>
        </ion-text>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding" style="--ion-background-color: #285756">
      
          <img src="assets/kett_mobile.png"/>
          <p style="color: white; font-size: 18px;">Welcome to the mobile version of the Keweenaw Time Traveler. Here you will be able to use your mobile device out in the field to explore the historical landscape through historic maps and stories shared by others. You also have the option of sharing your own story right from your device. For the best KeTT experience including historical datasets, please use the application on your desktop computer. </p>
          
      </ion-content>
    </ion-modal>                 
      		<div id="viewDiv"></div>           
          <ion-range value="100" mode="md"></ion-range> 
          <ion-fab horizontal="end" vertical="bottom" slot="fixed">
          <ion-fab-button color="locate" id="geolocation">
            <ion-icon name="locate-sharp" id="gpsicon"></ion-icon>
          </ion-fab-button>
        </ion-fab>
       </ion-content> 
        </ion-tab>

        <ion-tab tab="maps">
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>Maps</ion-title>
            </ion-toolbar>
          </ion-header>

          <ion-content fullscreen class="ion-padding" id="mapcontent">            
          Maps
          </ion-content>
        </ion-tab>

        <ion-tab tab="stories">         

        <ion-content fullscreen class="ion-padding" scroll-y="true">
        <ion-slides class="swiper-no-swiping">
          <ion-slide>
            <div class="slide">              
              <h2>Share your Story</h2>
              <p>
                Select where you want to <b>Share a Story.</b> 
              </p>
               <ion-button expand="block" id="locOpt">At my current location<ion-icon slot="start" name="locate-outline"></ion-icon></ion-button>
        <ion-button expand="block" id="mapOpt">From a location on the map<ion-icon slot="start" name="location-outline"></ion-icon></ion-button>
       <!--  <ion-button fill="clear" id="nextBtn1">Continue <ion-icon slot="end" name="arrow-forward"></ion-icon></ion-button> -->
        <p>Step 1 of 4</p>
        <ion-progress-bar value="0.25"></ion-progress-bar>


          </div>
          </ion-slide>

          <ion-slide>
            <div class="slide">
            
             <ion-list lines="full" class="ion-no-margin">
          <ion-list-header lines="full">
            <ion-label><h1>Story text</h1> </ion-label>
          </ion-list-header>
          
          <ion-item>
            <ion-label position="floating">Story Title<ion-text color="danger">*</ion-text></ion-label>
            <ion-input id="userTitle" required="true" placeholder="A short title for your story."></ion-input>
            <ion-text color="danger" style="display: none" id="titleError">Please enter a story title</ion-text>
          </ion-item>
           <ion-item>
            <ion-label position="floating">Story Timeframe<ion-text color="danger">*</ion-text></ion-label>
            <ion-input id="userDate" class="ion-invalid" required pattern="\d{4}-\d{2}-\d{2}" placeholder="1922 or 1920-1930 or 05-03-1932"></ion-input>
            <ion-text color="danger" style="display: none" id="dateError">Please enter a date in one of the specified formats.</ion-text>   
          </ion-item> 
        </ion-list>        

          <ion-item>
            <ion-label position="floating">Story Text (optional)</ion-label>
            <ion-textarea rows="6" cols="20" id="userDesc" placeholder="Type your story here. This is optional. In the next section you will have the option to record or upload video or audio of your story."></ion-textarea>
          </ion-item>
           <ion-item>
            <ion-label position="floating">Your Name (optional)</ion-label>
            <ion-input id="userName" placeholder="Enter your name here."></ion-input>
          </ion-item>
        </ion-list>
        <ion-button fill="clear" id="backBtn1">Previous <ion-icon slot="start" name="arrow-back"></ion-icon></ion-button>
         <ion-button fill="clear" id="nextBtn2">Continue <ion-icon slot="end" name="arrow-forward"></ion-icon></ion-button>
         <p>Step 2 of 4</p>
        <ion-progress-bar value="0.50"></ion-progress-bar>        
            </div>
          </ion-slide>
          <ion-slide>
            <div class="slide">
            <h2>Capture photos, audio and video related to your story.</h2>
            <input type="file" id="picInput" accept="image/*" capture="filesystem" style="display: none">
            <ion-button color="primary" expand="full" size="large" id="takePic">Take a Picture <ion-icon slot="end" name="camera-outline"></ion-icon></ion-button>
            <input type="file" id="audInput" accept="audio/*" capture="microphone" style="display: none">
            <ion-button color="primary" expand="full" size="large" id="takeAud">Record Audio <ion-icon slot="end" name="mic-outline"></ion-icon></ion-button>
             <input type="file" id="vidInput" accept="video/*" capture="camcorder" style="display: none">
             <ion-button color="primary" expand="full" size="large" id="takeVid">Record a Video <ion-icon slot="end" name="videocam-outline"></ion-icon></ion-button>
             <ion-button fill="clear" id="backBtn2">Previous <ion-icon slot="start" name="arrow-back"></ion-icon></ion-button>
         <ion-button fill="clear" id="nextBtn3">Continue <ion-icon slot="end" name="arrow-forward"></ion-icon></ion-button>
         <p>Step 3 of 4</p>
        <ion-progress-bar value="0.75"></ion-progress-bar>
       </div>
          </ion-slide>
          <ion-slide>            
            <h2>Submit Story</h2>
            <p><b>NOTE: This content will be publicly visible on the internet. You wonâ€™t be able to update or edit your submission so please double check your entries before submitting.</b></p>             
              <ion-button fill="clear" id="backBtn3">Previous <ion-icon slot="start" name="arrow-back"></ion-icon></ion-button>
              <ion-button fill="clear" type="submit" id="submitBtn">Submit</ion-button>
              <p>Step 4 of 4</p>
        <ion-progress-bar value="1"></ion-progress-bar>
          </ion-slide>
          <ion-slide>   
            <ion-icon name="checkmark-circle" style="font-size: 84px" color="primary"></ion-icon>         
            <h2>Story Submitted!</h2>
            <p><b>Thank you for you submission. Your story will now appear on the Keweenaw Time Traveler.</b></p>          
          </ion-slide>
        </ion-slides>
      </ion-content>
        </ion-tab>
        <ion-tab-bar slot="bottom">
          <ion-tab-button tab="home">
            <ion-label>Explore</ion-label>
            <ion-icon name="location-outline"></ion-icon>
          </ion-tab-button>
          <ion-tab-button tab="maps">
            <ion-label>Maps</ion-label>
            <ion-icon name="map-outline"></ion-icon>
            <ion-badge id="mapcount">6</ion-badge>
          </ion-tab-button>
          <ion-tab-button tab="stories">
            <ion-label>Share a Story</ion-label>
            <ion-icon name="book-outline"></ion-icon>
          </ion-tab-button>
        </ion-tab-bar>
      </ion-tabs>         
  </ion-content> 
    <ion-modal id="storyModal">
      <ion-header>
        <ion-toolbar color="favorite">
        	<ion-text color="white">
          <ion-title id="storymodaltitle">Story</ion-title>
      </ion-text>
          <ion-buttons slot="end">
          	<ion-text color="white">
            <ion-button id="modalClose">Close</ion-button>
        </ion-text>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
       <ion-card>
          <img src="" id="storyimg" />
          <ion-card-header>
            <ion-card-subtitle id="subtitle"></ion-card-subtitle>
            <ion-card-title id="storytitle">Madison, WI</ion-card-title>
          </ion-card-header>
          <ion-card-subtitle id="storyauthor" style="margin-left: 15px;"></ion-card-subtitle>
          <ion-card-content id="storydesc">
            Founded in 1829 on an isthmus between Lake Monona and Lake Mendota, Madison was named the capital of the
            Wisconsin Territory in 1836.              
          </ion-card-content>   
          <center><ion-label id="piclabel" class="media-label">Pictures</ion-label></center> 
          <div id="pictures"></div>      
          <center><ion-label id="vidlabel" class="media-label">Videos</ion-label></center>
          <div id="videos"></div>                  
          <center><ion-label id=audlabel class="media-label">Audio</ion-label></center>        
          <div id="sound"></div>  
        </ion-card>
      </ion-content>
    </ion-modal>
</ion-app>
  </body>
</html>
<script>
  require(["esri/config","esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/layers/TileLayer", "esri/widgets/Track", "esri/Graphic", "esri/layers/GraphicsLayer", "esri/geometry/support/webMercatorUtils", "esri/geometry/Point"], function (esriConfig, Map, MapView, FeatureLayer, TileLayer, Track, Graphic, GraphicsLayer, webMercatorUtils, Point) {

        async function presentToast() {
          const toast = document.createElement('ion-toast');
          toast.message = 'Press and hold on the map where you want to share a story.';
          toast.duration = 2000;
          document.body.appendChild(toast);
          return toast.present();
        }       

        var StoryModal = document.getElementById('storyModal');

        var splashModal = document.getElementById('splashModal');

        var slides = document.querySelector('ion-slides');

        const tabs = document.querySelector('ion-tabs');

        splashModal.isOpen = true;

        $( "#nextBtn1" ).click(function() {
          slides.update();
          slides.slideNext();
          console.log('slides');
        });

        $( "#backBtn1" ).click(function() {
          slides.update();
          slides.slidePrev();
          console.log('slides');
        });

        $( "#nextBtn2" ).click(function() {
          validate();
          //slides.update();
         // slides.slideNext();
          console.log('slides');
        });

        function validate() {
           const userDate = $('#userDate').val();
           const userTitle = $('#userTitle').val();
           console.log(userTitle, userDate);
           const dateRGEX = /^\d{4}$|^\d{4}-\d{4}$|^\d{2}-\d{2}-\d{4}$/;
           const dateResult = dateRGEX.test(userDate);
           console.log(dateResult);
          if (userTitle == "" || userTitle == null) {
            $("#titleError").css("display", "block");
            $("#userTitle").css("--border-color", "red");
            console.log("invalid story title!");
          } 
          if (dateResult == false) {
            $("#dateError").css("display", "block");
          } 

          if (dateResult == true && userTitle != "") {
            $("#titleError").css("display", "none");
            $("#dateError").css("display", "none");
            slides.update();
            slides.slideNext();
          }
        }        

        $( "#backBtn2" ).click(function() {
          // Validate the form input
          
          slides.update();
          slides.slidePrev();
          console.log('slides');
        });

        $( "#nextBtn3" ).click(function() {
          slides.update();
          slides.slideNext();
          console.log('slides');
        });

        $( "#backBtn3" ).click(function() {
          slides.update();
          slides.slidePrev();
          console.log('slides');
        });

        $( "#takeAud" ).click(function() {
         // const audFile = document.getElementById('audInput');
          //audFile.click();
          presentAlert();
        });

        $( "#takeVid" ).click(function() {
          const vidFile = document.getElementById('vidInput');
          vidFile.click();
        });

        $( "#takePic" ).click(function() {
          const picFile = document.getElementById('picInput');
          picFile.click();
          console.log('click');
        });

        // create an array of empty files  
        const files = [];
        // get files from input sources and push into array
        const picInput = document.getElementById('picInput');
          picInput.onchange = () => {            
            files.push(picInput.files[0]);
            console.log(picInput.files[0]);
            const picFileVal = $('#picInput').val();

            takePic.textContent = "..." + picFileVal.substring(20);
        }

      const vidInput = document.getElementById('vidInput');
          vidInput.onchange = () => {
            const selectedFile = vidInput.files[0];
            files.push(vidInput.files[0]);
            console.log(vidInput.files[0]);
            const vidFileVal = $('#vidInput').val();
            takeVid.textContent = "..." + vidFileVal.substring(20);
            console.log('This file size is: ' + files[0].size / 1024 / 1024 + "MB");
          }  

      const audInput = document.getElementById('audInput');
          audInput.onchange = () => {              
            files.push(audInput.files[0]);
            console.log(audInput.files[0]);
      }           

        // when the user clicks the audio record button
        $(document).on('click', '#record', function() {
          // check if the user has a microphone
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            console.log("getUserMedia supported.");
            navigator.mediaDevices
              .getUserMedia(
                // constraints - only audio needed for this app
                {
                  audio: true,
                }
              )

              // Success callback
              .then(function (stream) {
                 const options = {        
                 // mimeType: 'audio/mpeg'
                }
                 const mediaRecorder = new MediaRecorder(stream, options);
                 mediaRecorder.start();
               
                document.getElementById("message").innerHTML = '<center><ion-fab-button color="danger" id="stop" style="width: 120px; height: 120px;"><ion-icon name="mic-outline" id="stopicon" style="width: 100px; height: 100px;"></ion-icon></ion-fab-button></center>';

                alert.header = 'Recording...';
                alert.subHeader = 'Tap on the mic icon to stop recording.';

                function blink(){
                  $('#stop').delay(500).fadeTo(500,0.5).delay(500).fadeTo(500,1, blink);
                }

                $(document).ready(function() {
                    blink();
                });

                // setup a count timer for the audio recording
                let time = 0;
                
                const timer = setInterval(function(){  
                  time++;
                  let minutes = Math.floor(time / 60);
                  let seconds = time - minutes * 60;

                function str_pad_left(string,pad,length) {
                  return (new Array(length+1).join(pad)+string).slice(-length);
                }

                let finalTime = str_pad_left(minutes,'0',2)+':'+str_pad_left(seconds,'0',2);
                  document.getElementById("time").innerHTML = "<center><h2>" + finalTime + "</h2></center>";
                }, 1000);
               
                let chunks = [];

                mediaRecorder.ondataavailable = function (e) {
                  chunks.push(e.data);
                };

                // when the user clicks the audio stop button
                $(document).on('click', '#stop', function() {
                  // stop the timer
                  clearInterval(timer);
                  // stop the recording
                  mediaRecorder.stop();
                  const tracks = stream.getTracks();
                  tracks.forEach(function(track) {
                    track.stop();
                  });                  
                });

                mediaRecorder.onstop = function (e) {
                  const blob = new Blob(chunks, { type: "audio/mpeg" });
                  chunks = [];
                  const audioURL = window.URL.createObjectURL(blob);
                  const file = new File([blob], 'audiostory.mp3', {
                    type: blob.type,
                });
/*                  var link = document.createElement("a"); // Or maybe get it from the current document
link.href = audioURL;
link.download = "aDefaultFileName" + blob.type;
link.innerHTML = "Click here to download the file";
link.click();
document.body.appendChild(link);*/ 
                  console.log(file);
                  files.push(file);
                  //console.log(audioURL);
                  alert.dismiss();
                  takeAud.textContent = file.name;
                  //audio.src = audioURL;
                };                   
              })

              // Error callback
              .catch(function (err) {
                console.error(`The following getUserMedia error occurred: ${err}`);
              });
          } else {
            console.log("getUserMedia not supported on your browser!");
          }
        });

        // when the user clicks the story submit button
        $( "#submitBtn" ).click(function() {
          submitAlert.present();
          // get values from the story submission slides
          const title = $('#userTitle').val();
          const desc = $('#userDesc').val();
          const name = $('#userName').val();
          let date = $('#userDate').val();

          const yearRGEX = /^\d{4}$/;
          const rangeRGEX = /^\d{4}-\d{4}$/;
          const dateRGEX = /^\d{2}-\d{2}-\d{4}$/;

          const dateResult = dateRGEX.test(date);
          const yearResult = yearRGEX.test(date);
          const rangeResult = rangeRGEX.test(date);

          if (dateResult == true) {
            const dateSplit = date.split("-");
            console.log(date);
            date = dateSplit[2];
          }

          if (rangeResult == true) {
            const dateSplit = date.split("-");
            date = dateSplit[0];
          }

          if (yearResult == true) {
            date = date;
          }

          console.log(title, desc, name, date);

          // on submit button add features to stories map service
          const featureServiceLayerUrl = 'https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/giscore_grf_CCHSDI_Storypts/FeatureServer/0';
          // create a new feature to add using the REST API
          const featureToAdd = {
            attributes: {              
              title: title,
              description: desc,              
              name: name,
              beginDate: date,
              endDate: date,
              userdate: date,
              mapyear: date,              
            },
            geometry: {
              x: lon,
              y: lat,
              spatialReference: {
                wkid: 4326
              }
            }
          };

      // begin by adding a new feature to the feature service layer,
      // then update its attributes,
      // and finally delete it from the layer
      arcgisRest
        .addFeatures({
          url: featureServiceLayerUrl,
          features: [featureToAdd],
          //authentication
        })
        .then(handleAdded);

      function handleAdded(response) {
        console.log(response);
        if (response.addResults[0].success === true) {
          const storyObjId = response.addResults[0].objectId;
          console.log(files, files.length);
          if (files.length > 0) {
            files.forEach(function(file) {
            arcgisRest
              .addAttachment({
                url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/giscore_grf_CCHSDI_Storypts/FeatureServer/0",
                featureId: storyObjId,
                attachment: file
              })
                .then(attachmentAdded);
                function attachmentAdded (newresponse) {
                  submitAlert.dismiss();
                  console.log(newresponse);
                  slides.update();
                  slides.slideNext();
                }
            });
         } else {
           submitAlert.dismiss();
           slides.update();
           slides.slideNext();
         }         
        }

        if (!response.addResults[0].success) {
          // stop early if adding a new feature was not successful
          return;
        }
      }
      });      
        async function presentAlert() { 
       // Setup the alerts
        const alert = document.createElement('ion-alert');
        alert.header = 'Record a Story';
        alert.subHeader = 'Tap on the mic icon to begin recording.';
        alert.message = '<div id="message"><center><ion-fab-button class="green" id="record" style="width: 120px; height: 120px; !important"><ion-icon name="mic-outline" id="micicon" style="width: 1,h200px; height: 100px"></ion-icon></ion-fab-button></center></div><br><div id="time"><center><h2>0.00</h2></center></div>'; 
        document.body.appendChild(alert);
        await alert.present();
        };  
        
                
        
        const submitAlert = document.createElement('ion-alert');
        submitAlert.header = 'Submitting Story...';
        //submitAlert.subHeader = 'Speak into the microphone';
        submitAlert.message = '<ion-spinner color="primary"></ion-spinner>'; 
        submitAlert.backdropDismiss = false;   

        document.body.appendChild(submitAlert);        
    
        // Optional parameters to pass to the swiper instance.
        // See https://swiperjs.com/swiper-api for valid options.
        slides.options = {
          initialSlide: 1,
          speed: 400,
         // allowTouchMove: false,

        }       
       // slides.lockSwipes(true);
        
       // slides.update();

       // modal.breakpoints = [0, 0.25, 0.5, 0.75];
  
        // styling for the story points layer
        const storiesRenderer = {
          "type": "simple",
          "symbol": {
            "type": "picture-marker",
            "url": "assets/marker_story.png",
            "width": "18px",
            "height": "18px"
          }
        };

        // Layer for the map index 
  	    const indexLayer = new FeatureLayer({
  	      url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/KeTT_Mobile_Map_Indexes/FeatureServer/0",
  	      outFields: ["title", "year", "service_url"], // Return all fields so it can be queried client-side
  	      opacity: 0
  	    //renderer: renderer
  	    });

        // Layer for the story points
        const storyLayer = new FeatureLayer({
          url: "https://portal1-geo.sabu.mtu.edu:6443/arcgis/rest/services/KeweenawHSDI/story_pts_watts2/FeatureServer/0",
          outFields: ["title", "description", "name", "userdate", "objectid"], // Return all fields so it can be queried client-side        
          renderer: storiesRenderer,
          definitionExpression: "flag IS NULL"
        });

        const graphicsLayer = new GraphicsLayer();
	    //map.add(graphicsLayer);

        const map = new Map({
          basemap: "satellite", // Basemap layer service
          layers: [indexLayer, storyLayer, graphicsLayer]
        });

        const view = new MapView({
          map: map,
          center: [-88.5694, 47.1211], // Longitude, latitude
          zoom: 10, // Zoom level
          container: "viewDiv", // Div element          
        });    

        // Removes the zoom widget from the view
        view.ui.remove("zoom");      

        // new gelocation widget
        let track = new Track({
          view: view,
          useHeadingEnabled: false,
          goToLocationEnabled: false, 
          geolocationOptions: { maximumAge: 0, timeout: 15000, enableHighAccuracy: true }
        });

        //view.ui.add(track, "top-left"); 

        // The sample will start tracking your location
        // once the view becomes ready
        view.when(function () {
          
        });

        $( "#geolocation" ).click(function() {
         // track.start();
         if (track.tracking == false) {
         	track.start();
         	document.getElementById("gpsicon").style.color = "#3880ff";
          track.once("track", ({ position }) => {
           currentCoords = position.coords;
           const point = new Point({
              latitude: currentCoords.latitude,
              longitude: currentCoords.longitude
            });
            view.goTo({target: point, scale: 5000, speedFactor: 0.1});
            console.log(currentCoords);
          });
         } else {
         	track.stop();
         	document.getElementById("gpsicon").style.color = "black";
         }            
        });

        // declare lat and long on global scales
        let lat;
        let lon;

        function setGeolocation() {
          const geolocation = window.navigator.geolocation.watchPosition( function ( position ) {
           
                 window.setTimeout( function () {
                  lat = position.coords.latitude;
                  lon = position.coords.longitude;          
                  }, 5000 );
                
        },
        function () {
            //error
            console.log("No GPS Support");
        },
        {
            maximumAge: 0, 
            enableHighAccuracy: true
        } 
      );

      window.setTimeout( function () {
          window.navigator.geolocation.clearWatch( geolocation ) 
      }, 5000 );
        };

        $( "#locOpt" ).click(function() {
          if (track.tracking == false) {
             setGeolocation();            
             slides.update();
             slides.slideTo(1);
               
        } else {
          lat = currentCoords.latitude;
          lon = currentCoords.longitude;
          slides.update();
          slides.slideTo(1);
         /* if(navigator.geolocation){
              // GET LOCATION FROM BROWSER //
              navigator.geolocation.getCurrentPosition(position => {
                slides.update();
                slides.slideTo(1);
                // SET LOCATION //
                lat = position.coords.latitude;
                lon = position.coords.longitude;
                //survey123WebForm.setGeopoint({ x: position.coords.longitude, y: position.coords.latitude });
              }, () => { console.error('Unable to retrieve your location'); });
            } else {console.error('Geolocation is not supported by your browser'); }*/
        }
        });

        $( "#mapOpt" ).click(function() {
          tabs.select('home');
          presentToast();          
          view.on("hold", function(evt) {                
            lat = evt.mapPoint.latitude
            lon = evt.mapPoint.longitude
            tabs.select('stories');
            return setTimeout(() => {
                slides.update();
            slides.slideTo(1); 
            }, 50);        
             
            console.log('map hold' + lon,lat); 
                               
          });
        });

        const listNode = document.getElementById("mapcontent");

        let graphics; 
  	    view.whenLayerView(indexLayer).then(function(layerView) {
    		  layerView.watch("updating", function(value) { 
    		  	  listNode.innerHTML = "";	  		  	  		  	  	
  			  if (!value) {			  	
  			    // wait for the layer view to finish updating

  			    // get all the features available for drawing.
  			    layerView
  			      .queryFeatures({
  			        geometry: view.extent,
  			        returnGeometry: true
  			      })
  			      .then(function(results) {
  			        // do something with the resulting graphics
  			        graphics = results.features;
                
                // Sort the features first by title, then by year  
                graphics.sort(function (a, b) {
                  return a.attributes.title.localeCompare(b.attributes.title) || a.attributes.year - b.attributes.year;
                });

                document.getElementById("mapcount").innerHTML = results.features.length;
  			       	let item;
  			        const fragment = document.createDocumentFragment();
  			        graphics.forEach(function(result, index) {
                    const attributes = result.attributes;
                    const title = attributes.title;
                    const year = attributes.year;
                    console.log(title);
                    item = document.createElement("ion-item");
                    const label = document.createElement("ion-label");
                    const icon = document.createElement("ion-icon"); 
                    item.href = "#";                     
                    icon.name = "map-outline";
                    item.detail = "false";                                         
                    icon.slot = "end";
                    label.innerHTML = year + " " + title;	
                    item.appendChild(icon);
                    item.appendChild(label);
                    item.addEventListener("click", () => resultClickHandler(result, index));
                    fragment.appendChild(item);                     
               	    listNode.appendChild(fragment);
                  });  

  			        function resultClickHandler(result, index) {         				        	
                 // item.classList.add("invalid");
                  tabs.select('home');
  				        const popup = graphics && graphics[parseInt(index, 10)];
  				     
    				      map.allLayers.filter(function(layer) {
  				     	    if (layer.type === "tile") {
  				     		    map.remove(layer);
  				     	    } 
                	});			    

  				        let current_layer = new TileLayer({
  			             url: result.attributes.service_url
  			        	});

  			        	map.add(current_layer);

		                // push the current layer to the back
		                map.reorder(current_layer, 1);

		                // get the value of the range slider  
		                let rangeVal = $( "ion-range" ).val();
		               
		                current_layer.opacity = rangeVal / 100;  

		                const range = document.querySelector('ion-range');
		                // const lastEmittedValue = document.querySelector('#lastValue');
		                // adjust the transparency of the map based on the sliders value  
		                range.addEventListener('ionChange', ({ detail }) => {		                  
		                    current_layer.opacity = detail.value / 100;                  
		                });			        

  				      /*if (popup) {
  				        view.popup.open({
  				          features: [popup],
  				          location: result.geometry.centroid
  				        });       
  				        const extent = result.geometry.extent;
  				        // when clicking on a record zoom to its extent
  				        view.goTo({ center: extent.expand(6) }, { duration: 400 });
  				      }				     */
  				      };
  			      });
  			  }
  		  });	
  		});

        view.on("click", (event) => {
          // only include graphics from the layer in the hitTest
          const opts = {
            include: storyLayer
          }
          // check for a click on the story layer
          view.hitTest(event, opts).then((response) => {
            $("#storyimg").attr("src", ""); 
            $("#piclabel").hide();
            $("#audlabel").hide();
            $("#vidlabel").hide();
            document.getElementById("pictures").innerHTML = "";
            document.getElementById("videos").innerHTML = "";
            document.getElementById("sound").innerHTML = "";           

            // check if a feature is returned from the index layer
            if (response.results.length) {
              const graphic = response.results[0].graphic; 
              console.log(graphic);
              const objectId = graphic.attributes.objectid;
              const title = graphic.attributes.title;
              const desc = linkifyHtml(graphic.attributes.description);
              const date = graphic.attributes.userdate;
              const name = graphic.attributes.name;
              $('#subtitle').html(date); 
              $('#storydesc').html(desc); 
              $('#storytitle').html(title); 
              $('#storymodaltitle').html(title);
              if (name == "" || name == null  ) {
              	$('#storyauthor').html("by Anonymous");
              } else {
              	$('#storyauthor').html("by " + name);
              }
              // Open the modal popup for storeis
              storyModal.isOpen = true;
              // Query the attachments from the clicked story
              storyLayer.queryAttachments({
              //  attachmentTypes: ["image/jpeg", "video/mp4", "sound/mp3"],
                objectIds: objectId
              }).then(function (attachmentsByFeatureId) {
                console.log(attachmentsByFeatureId);
                if (!attachmentsByFeatureId) {
                    return;
                 }
                if (Object.keys(attachmentsByFeatureId).length === 0){
                  // if there are no attachments, do something here.
                  $("#storyimg").attr("src", "");                   
                 }
                // Display the attachments
                Object.keys(attachmentsByFeatureId)
                  .forEach(function(objectId) {
                    const attachments = attachmentsByFeatureId[objectId];
                    attachments.forEach(function (attachment) {                   
                      if (attachment.contentType == "image/jpeg" || attachment.contentType == "image/png" || attachment.contentType == "image/gif") {
                       
                        const imgarray = [];
                        imgarray.push(attachment);
                        const attachUrl = imgarray[0].url;
                        $("#storyimg").attr("src",attachUrl);
                       // imgarray.forEach(function(image, index) {
                          
                          //if (index ===0) {
                            $("#piclabel").show();
                         		const elem = document.createElement("img");
                         		elem.src = imgarray[0].url;
                         		document.getElementById("pictures").appendChild(elem);
                         // }
                        //}); 
                        //console.log(attachUrl);
                      } else if (attachment.contentType == "video/mp4") {
                        $("#vidlabel").show();
                        const vidarray = [];
                        vidarray.push(attachment);
                        const vidUrl = vidarray[0].url;
                        const video = document.createElement('video');
                       // video.classList.add("controls");
            						const source = document.createElement('source');

            						source.setAttribute('src', vidUrl);
            						source.setAttribute('type', 'video/mp4');
                        document.getElementById("videos").appendChild(video);

            						video.appendChild(source);	
                        video.controls = "true";  
                        video.style.width = "100%";
            						video.load();
                      } else if (attachment.contentType == "audio/mpeg") {
                        $("#audlabel").show();
                      	const audarray = [];
                      	audarray.push(attachment);
                      	const audUrl = audarray[0].url;
                      	const audio = document.createElement('audio');
            						const source = document.createElement('source');

            						source.setAttribute('src', audUrl);
            						source.setAttribute('type', 'audio/mpeg');
                        document.getElementById("sound").appendChild(audio);
            						audio.appendChild(source);	
                        audio.controls = "true";
                        audio.style.width = "100%";
            						audio.load();
                      }
                    });
                  }); 
              });
            }    
          });
        });

         storyModal.addEventListener('didDismiss', (ev) => {
           storyModal.isOpen = false;
         });
         $( "#modalClose" ).click(function() {
         	storyModal.isOpen = false;
         });

          splashModal.addEventListener('didDismiss', (ev) => {
           splashModal.isOpen = false;
         });
         $( "#splashModalClose" ).click(function() {
          splashModal.isOpen = false;
         });

         
    });
</script>
<style>
  ion-content ion-toolbar {
    margin: 10px 0;
  }
</style>